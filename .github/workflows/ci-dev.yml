name: ðŸš€ Dev Branch CI/CD

on:
  push:
    branches: 
      - 'dev'
  pull_request:
    branches:
      - 'dev'

env:
  NODE_VERSION: '18'
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Job 1: Installation et validation
  setup:
    name: ðŸ“¦ Setup & Validation
    runs-on: ubuntu-latest
    outputs:
      backend-cache-key: ${{ steps.backend-cache.outputs.cache-hit }}
      frontend-cache-key: ${{ steps.frontend-cache.outputs.cache-hit }}
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          
      - name: ðŸ’¾ Cache Backend Dependencies
        id: backend-cache
        uses: actions/cache@v4
        with:
          path: |
            backend/node_modules
            backend/.pnpm-store
          key: backend-deps-${{ hashFiles('backend/package.json', 'backend/pnpm-lock.yaml') }}
          
      - name: ðŸ’¾ Cache Frontend Dependencies
        id: frontend-cache
        uses: actions/cache@v4
        with:
          path: |
            front/node_modules
          key: frontend-deps-${{ hashFiles('front/package.json', 'front/package-lock.json') }}

      - name: ðŸ”§ Install Backend Dependencies
        if: steps.backend-cache.outputs.cache-hit != 'true'
        run: |
          cd backend
          pnpm install --frozen-lockfile
          
      - name: ðŸ”§ Install Frontend Dependencies
        if: steps.frontend-cache.outputs.cache-hit != 'true'
        run: |
          cd front
          npm ci

  # Job 2: Tests complets
  tests:
    name: ðŸ§ª Comprehensive Tests
    runs-on: ubuntu-latest
    needs: [setup]
    strategy:
      matrix:
        test-type: [unit, integration]
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          
      - name: ðŸ’¾ Restore Backend Cache
        uses: actions/cache@v4
        with:
          path: |
            backend/node_modules
            backend/.pnpm-store
          key: backend-deps-${{ hashFiles('backend/package.json', 'backend/pnpm-lock.yaml') }}
          
      - name: ðŸ’¾ Restore Frontend Cache
        uses: actions/cache@v4
        with:
          path: |
            front/node_modules
          key: frontend-deps-${{ hashFiles('front/package.json', 'front/package-lock.json') }}

      - name: ðŸ§ª Run Backend Tests (${{ matrix.test-type }})
        run: |
          cd backend
          if [ "${{ matrix.test-type }}" == "unit" ]; then
            echo "ðŸ§ª Running unit tests..."
            pnpm test:coverage
          else
            echo "ðŸ§ª Running integration tests..."
            pnpm test
          fi
          
      - name: ðŸ§ª Run Frontend Tests (${{ matrix.test-type }})
        run: |
          cd front
          if [ "${{ matrix.test-type }}" == "unit" ]; then
            echo "ðŸ§ª Running unit tests..."
            npm run test:coverage
          else
            echo "ðŸ§ª Running integration tests..."
            npm test
          fi
          
      - name: ðŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            backend/coverage/
            front/coverage/
            backend/test-results/
            front/test-results/
          retention-days: 7

  # Job 3: Build production
  build:
    name: ðŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    needs: [setup]
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          
      - name: ðŸ’¾ Restore Backend Cache
        uses: actions/cache@v4
        with:
          path: |
            backend/node_modules
            backend/.pnpm-store
          key: backend-deps-${{ hashFiles('backend/package.json', 'backend/pnpm-lock.yaml') }}
          
      - name: ðŸ’¾ Restore Frontend Cache
        uses: actions/cache@v4
        with:
          path: |
            front/node_modules
          key: frontend-deps-${{ hashFiles('front/package.json', 'front/package-lock.json') }}

      - name: ðŸ—ï¸ Build Backend
        run: |
          cd backend
          echo "ðŸ—ï¸ Building backend for production..."
          npx tsc --noEmit --skipLibCheck
          
      - name: ðŸ—ï¸ Build Frontend
        run: |
          cd front
          echo "ðŸ—ï¸ Building frontend for production..."
          npm run build
          
      - name: ðŸ“¦ Package Build
        run: |
          echo "ðŸ“¦ Creating production package..."
          tar -czf production-build.tar.gz front/build backend/dist
          
      - name: ðŸ’¾ Upload Production Build
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: production-build.tar.gz
          retention-days: 30

  # Job 4: SonarCloud Dev Analysis
  sonarcloud:
    name: ðŸ“Š SonarCloud Dev Analysis
    runs-on: ubuntu-latest
    needs: [tests]
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“¥ Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-unit
          path: ./coverage/
          
      - name: ðŸ“Š SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=thibvv
            -Dsonar.projectKey=ThibVv_kempo
            -Dsonar.branch.name=dev
            -Dsonar.sources=backend/src,front/src
            -Dsonar.tests=backend/src/__tests__,front/src
            -Dsonar.javascript.lcov.reportPaths=coverage/backend/lcov.info,coverage/front/lcov.info
            -Dsonar.coverage.exclusions=**/*.test.js,**/*.test.ts,**/*.spec.js,**/*.spec.ts
            -Dsonar.cpd.exclusions=**/*.test.js,**/*.test.ts

  # Job 5: Quality Gate
  quality-gate:
    name: ðŸšª Dev Quality Gate
    runs-on: ubuntu-latest
    needs: [sonarcloud]
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸšª Wait for Quality Gate
        uses: sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
          
      - name: âœ… Quality Gate Status
        run: |
          echo "ðŸŽ‰ Dev Quality Gate passed!"
          echo "âœ… Code quality maintained"
          echo "âœ… Security standards met"
          echo "âœ… Ready for staging deployment"

  # Job 6: DÃ©ploiement staging (simulÃ©)
  staging-deploy:
    name: ðŸš€ Staging Deployment
    runs-on: ubuntu-latest
    needs: [build, quality-gate]
    if: github.event_name == 'push'
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download Production Build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./deploy/
          
      - name: ðŸš€ Deploy to Staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "ðŸ“¦ Extracting build artifacts..."
          cd deploy
          tar -xzf production-build.tar.gz
          echo "âœ… Staging deployment completed"
          
      - name: ðŸ¥ Health Check
        run: |
          echo "ðŸ¥ Running health checks..."
          echo "âœ… Backend health: OK"
          echo "âœ… Frontend health: OK"
          echo "âœ… Database connection: OK"
          echo "ðŸŽ‰ Staging environment is healthy!"
          
      - name: ðŸ“ Deployment Summary
        run: |
          echo "## ðŸš€ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | âœ… Connected |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Staging deployment successful!**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Staging URL:** https://staging.kempo-app.com" >> $GITHUB_STEP_SUMMARY
