name: ğŸ”„ Auto-merge Feature to Dev

on:
  workflow_run:
    workflows: ["SonarCloud Quality Gate"]
    types: [completed]
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge-to-dev:
    name: ğŸ”„ Auto-merge to Dev
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“Š Get Branch Info
        id: branch_info
        run: |
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "pr_title=Auto-merge: $BRANCH_NAME â†’ dev" >> $GITHUB_OUTPUT
          echo "pr_body=ğŸ¤– **Automatic merge from feature branch**

          **Source Branch:** \`$BRANCH_NAME\`
          **Target Branch:** \`dev\`
          **Triggered by:** SonarCloud Quality Gate success
          
          âœ… **Validations passed:**
          - Feature branch tests
          - SonarCloud quality gate
          - Code quality checks
          
          This PR was automatically created after all quality checks passed." >> $GITHUB_OUTPUT

      - name: ğŸ”„ Create Pull Request to Dev
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch_info.outputs.branch_name }}
          base: dev
          title: ${{ steps.branch_info.outputs.pr_title }}
          body: ${{ steps.branch_info.outputs.pr_body }}
          labels: |
            auto-merge
            feature
            ready-for-dev
          reviewers: ThibVv
          
      - name: ğŸ¯ Auto-approve and Merge PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Attendre que la PR soit crÃ©Ã©e
          sleep 10
          
          # RÃ©cupÃ©rer le numÃ©ro de la PR
          PR_NUMBER=$(gh pr list --head "${{ steps.branch_info.outputs.branch_name }}" --base dev --json number --jq '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "ğŸ” Found PR #$PR_NUMBER"
            
            # Auto-approuver la PR
            gh pr review $PR_NUMBER --approve --body "âœ… Auto-approved after successful SonarCloud validation"
            
            # Merger la PR
            gh pr merge $PR_NUMBER --squash --auto
            
            echo "âœ… PR #$PR_NUMBER merged successfully"
          else
            echo "âŒ No PR found for branch ${{ steps.branch_info.outputs.branch_name }}"
            exit 1
          fi

      - name: ğŸ§¹ Cleanup Feature Branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Supprimer la branche feature aprÃ¨s merge rÃ©ussi
          git push origin --delete "${{ steps.branch_info.outputs.branch_name }}"
          echo "ğŸ—‘ï¸ Feature branch ${{ steps.branch_info.outputs.branch_name }} deleted"

      - name: ğŸ“¢ Success Notification
        run: |
          echo "ğŸ‰ **Auto-merge completed successfully!**"
          echo "âœ… Feature branch merged to dev"
          echo "ğŸ—‘ï¸ Feature branch cleaned up"
          echo "ğŸš€ Ready for next development cycle"
